# リリース準備 - 懸念点と修正計画（2日以内）

最終更新: 2025年10月26日

## 📊 現状サマリー

### ✅ 良好な点
- **本番環境**: 稼働中（https://main.d3vnoskfyyh2d2.amplifyapp.com）
- **データ**: 組織3件、販売店5件、動画14件が登録済み
- **ユーザー**: Cognito 6ユーザー（system-admin 1, org-admin 2, shop-admin 3）
- **Lambda関数**: 23個デプロイ済み
- **DynamoDB**: 5テーブル正常稼働

### 🔴 重大な懸念点（24時間以内に修正必須）

#### 1. **動画アップロード機能が未検証**
**症状**: 実際のS3アップロードが本番環境で動作するか未確認

**影響度**: ★★★★★（システムのコア機能）

**現状**:
- バックエンド: `generate-upload-url` Lambda関数は実装・デプロイ済み（`ServerSideEncryption: 'AES256'`含む）
- フロントエンド: `useUpload.ts`が実際のアップロード処理に置き換わった（最新コミット `622ec33`）
- **未確認**: 本番環境で実際のアップロードが動作するか

**修正計画**:
1. ✅ Amplifyビルド成功確認（完了）
2. ⚠️ 実際のアップロードテスト（未実施）
   - 木村販売店（`kimura@example.com`）でログイン
   - 小さいMP4ファイル（1-2MB）をアップロード
   - ブラウザコンソールでログ確認:
     - `Step 1: 署名付きURL取得中...`
     - `✔ 署名付きURL取得成功`
     - `Step 2: S3へアップロード中...`
     - `アップロード進捗: 10%, 20%, ...`
     - `✔ S3アップロード成功`
     - `✔ アップロード完了`
   - S3バケット（`video-nfc-videos-prod-271633506783`）でファイル確認
   - DynamoDB（`video-nfc-VideoMetadata-prod`）でメタデータ確認
   - 動画一覧ページで表示確認

**リスク**: この機能が動作しないと、システムとして使用不可

**緊急対応プラン**:
- Lambda関数のCloudWatch Logsを確認
- S3バケットのCORS設定を確認
- Pre-signed URLの有効期限を確認
- 暗号化ヘッダー（`x-amz-server-side-encryption: AES256`）の送信確認

---

#### 2. **デバッグコードが本番環境に残存**
**症状**: `console.log/warn`が7ファイル、23箇所に残存

**影響度**: ★★★☆☆（パフォーマンスと機密性）

**該当ファイル**:
- `hooks/useUpload.ts`: 7箇所（アップロード進捗・エラーログ）
- `app/shop/stats/page.tsx`: 2箇所
- `app/admin/organizations/page.tsx`: 2箇所
- `hooks/useAuth.ts`: 5箇所
- `hooks/useOrganizationStats.ts`: 2箇所
- `app/login/page.tsx`: 2箇所

**修正計画**:
1. 本番環境で必要なログのみ残す（`console.error`）
2. `console.log`, `console.warn`, `console.debug`を削除
3. 機密情報（トークン、パスワード、署名付きURL）が出力されていないか再確認
4. アップロード機能検証後に実施（デバッグ情報が必要なため）

**優先度**: 中（アップロード機能検証完了後すぐに実施）

---

#### 3. **エラーハンドリングの不完全性**
**症状**: 一部APIでエラーが適切に処理されていない可能性

**影響度**: ★★★★☆（ユーザー体験）

**懸念点**:
- ネットワークエラー時の挙動
- 認証エラー（401/403）時の挙動
- API Gateway 5xx エラー時の挙動
- タイムアウトエラー時の挙動
- S3アップロード失敗時の挙動

**修正計画**:
1. 主要なページでエラー表示を確認
   - ログインページ: 認証エラー
   - アップロードページ: ネットワークエラー、S3エラー
   - 動画一覧ページ: APIエラー
   - 統計ページ: データ取得エラー
2. `try-catch`ブロックの確認
3. ユーザーフレンドリーなエラーメッセージを追加
4. エラー時のリトライ機能の確認

**優先度**: 中

---

### 🟡 中程度の懸念点（48時間以内に対応推奨）

#### 4. **パスワードポリシーとアカウント管理**
**症状**: 
- 販売店作成時のパスワードが8文字ランダム英数字のみ
- ログイン情報モーダルにパスワードが表示されない（パスワードリセット機能実装済み）
- 既存メールアドレスでの登録試行時は409エラーを返す（実装済み）

**影響度**: ★★★☆☆（セキュリティとUX）

**現状**:
- パスワードリセット機能実装済み（`resetShopPassword` API）
- メール送信機能あり（Cognito経由）
- 初回ログイン時のパスワード変更は強制されない
- パスワード生成ロジック: `lambda/src/handlers/createShop.ts` 27-35行目

**確認項目**:
- パスワードリセットメールが正しく送信されるか
- メール内容が適切か（日本語、ブランディング）
- リセットフローが正常に動作するか
- Cognitoのパスワードポリシー設定確認

**優先度**: 中（リリース前にテスト推奨）

---

#### 5. **組織管理者の動画アップロード制限**
**症状**: 組織管理者は直接アップロードできず、販売店管理者に依頼する必要がある

**影響度**: ★★☆☆☆（UX）

**現状**:
- 意図的な設計（以前の修正で確認済み）
- アップロードページに制限メッセージが表示されるはず
- `app/upload/page.tsx`で実装済み（過去の修正）

**確認項目**:
- 組織管理者でログイン時にメッセージが適切に表示されるか
- アップロードボタンが無効化されているか

**優先度**: 低（設計通り、確認のみ）

---

#### 6. **環境変数の管理**
**症状**: Amplify環境変数の設定確認が必要

**影響度**: ★★★☆☆（デプロイの安定性）

**懸念点**:
- `NEXT_PUBLIC_API_BASE_URL`が本番APIを指しているか
- 環境変数の値がローカルと本番で異なるか

**確認項目**（Amplify Console）:
```bash
NEXT_PUBLIC_API_BASE_URL=https://xxx.execute-api.ap-northeast-1.amazonaws.com/prod
NEXT_PUBLIC_COGNITO_USER_POOL_ID=ap-northeast-1_tRsVTmwXn
NEXT_PUBLIC_COGNITO_USER_POOL_CLIENT_ID=xxx
NEXT_PUBLIC_COGNITO_REGION=ap-northeast-1
NEXT_PUBLIC_APP_ENV=production
```

**確認方法**:
1. Amplify Console → アプリ設定 → 環境変数
2. ブラウザコンソールで `window.location.origin` と API URLを確認
3. ネットワークタブでAPIリクエストのURLを確認

**優先度**: 中

---

### 🟢 低優先度の懸念点（リリース後対応可）

#### 7. **パフォーマンス最適化**
**症状**: React Queryのキャッシュ設定が未最適化

**影響度**: ★★☆☆☆（ユーザー体験）

**懸念点**:
- `staleTime`, `cacheTime`がデフォルト値
- 不要な再レンダリングがある可能性
- 動画サムネイルのローディング最適化

**優先度**: 低（リリース後対応）

---

#### 8. **監視とアラート**
**症状**: CloudWatch Alarms未設定

**影響度**: ★★★☆☆（運用）

**必要な設定**:
- Lambda エラー率の監視（>1%でアラート）
- API Gateway 5xx エラー率の監視（>0.5%でアラート）
- DynamoDB スロットリングの監視
- S3 4xx/5xxエラーの監視

**優先度**: 低（リリース後すぐ対応）

---

#### 9. **セキュリティ監査**
**症状**: 包括的なセキュリティチェック未実施

**影響度**: ★★★★☆（セキュリティ）

**確認項目**:
- CORS設定は適切か（現在`*`、本番では制限推奨）
- S3バケットのパブリックアクセス設定（現在BLOCK_ALL）
- Cognito User Poolの設定（MFA、パスワードポリシー）
- Lambda環境変数の暗号化
- CloudWatch Logsの機密情報漏洩チェック
- API Gatewayのレート制限設定

**優先度**: 中（リリース前に簡易チェック推奨）

---

#### 10. **ドキュメンテーション**
**症状**: ユーザーマニュアル未整備

**影響度**: ★★☆☆☆（サポート負荷）

**必要なドキュメント**:
- システム管理者マニュアル
- 組織管理者マニュアル
- 販売店管理者マニュアル
- トラブルシューティングガイド

**優先度**: 低（リリース後対応）

---

## 🚨 リリース前の必須タスク（24時間以内）

### Phase 1: 動画アップロード機能の完全検証（最優先）
**所要時間**: 1-2時間

1. ✅ Amplifyビルド成功確認
2. ⚠️ **本番環境で実際のアップロードテスト**
   - [ ] 木村販売店（`kimura@example.com`）でログイン
   - [ ] 小さいMP4ファイル（1-2MB）を用意
   - [ ] ブラウザのDevToolsコンソールを開く
   - [ ] アップロードページで動画を選択
   - [ ] タイトルを入力
   - [ ] アップロードボタンをクリック
   - [ ] コンソールログを確認:
     - `Step 1: 署名付きURL取得中...`
     - `✔ 署名付きURL取得成功`
     - `Step 2: S3へアップロード中...`
     - `アップロード進捗: 10%, 20%, 30%...100%`
     - `✔ S3アップロード成功`
     - `✔ アップロード完了`
   - [ ] 進捗バーが正しく表示されるか確認
   - [ ] 完了画面が表示されるか確認
   - [ ] 動画一覧ページで新しい動画が表示されるか確認
3. [ ] **バックエンド確認**
   - [ ] CloudWatch Logsで`GenerateUploadUrlFn`のログ確認
   - [ ] S3バケット（`video-nfc-videos-prod-271633506783`）でファイル確認
   - [ ] DynamoDB（`video-nfc-VideoMetadata-prod`）でメタデータ確認
4. [ ] **エラー時の対応**
   - エラーが発生した場合、エラーメッセージとスタックトレースを記録
   - CloudWatch Logsを確認
   - 緊急修正計画を立案

### Phase 2: 全ユーザーロールでの動作確認
**所要時間**: 2-3時間

#### 2.1 システム管理者（`system-admin@example.com` / `AdminPass123!`）
- [ ] ログイン成功
- [ ] ダッシュボード表示
- [ ] システム統計ページ（`/admin/system-stats`）表示
  - 組織数、販売店数、動画数が正しく表示されるか
- [ ] 組織管理ページ（`/admin/organizations`）表示
  - 全組織が表示されるか
  - 各組織の販売店数・動画数が正しいか
- [ ] 動画一覧ページ（`/videos`）表示
  - 全動画が表示されるか（14件）
  - 組織名・店舗名が正しく表示されるか
- [ ] **組織作成機能テスト**
  - 新規組織を作成
  - 作成後のモーダル表示確認
  - 組織一覧に反映されるか確認
- [ ] **販売店作成機能テスト**
  - 既存組織に販売店を追加
  - 作成後のモーダル表示確認（パスワードリセットボタン）
  - 販売店一覧に反映されるか確認
- [ ] ログアウト

#### 2.2 組織管理者（`orga-admin@example.com` / パスワード要確認）
- [ ] ログイン成功
- [ ] 左サイドバーに組織名が表示されるか
- [ ] 自社管理ページ（`/admin/organizations`）表示
  - 自組織の販売店のみ表示されるか
  - 他組織の販売店が表示されないか
- [ ] 販売店統計ページ（`/shop/stats`）表示
  - 自組織の販売店統計が表示されるか
- [ ] 動画一覧ページ（`/videos`）表示
  - 自組織の動画のみ表示されるか
- [ ] **販売店作成機能テスト**
  - 自組織に販売店を追加
  - 作成後のモーダル表示確認
- [ ] アップロードページ（`/upload`）
  - 制限メッセージが表示されるか
  - アップロードボタンが無効化されているか
- [ ] システム統計ページにアクセス試行
  - アクセス拒否されるか（403または404）
- [ ] ログアウト

#### 2.3 販売店管理者（`kimura@example.com` / パスワード要確認）
- [ ] ログイン成功
- [ ] 左サイドバーに店舗名が表示されるか
- [ ] 販売店統計ページ（`/shop/stats`）表示
  - 自店舗の統計が表示されるか
  - 他店舗の統計が表示されないか
- [ ] 動画一覧ページ（`/videos`）表示
  - 自店舗の動画のみ表示されるか
- [ ] **動画アップロード機能テスト**（Phase 1で実施済みの場合はスキップ）
  - MP4ファイルをアップロード
  - 進捗表示確認
  - 完了画面確認
  - 動画一覧に反映確認
- [ ] **動画削除機能テスト**
  - アップロードした動画を削除
  - 削除確認ダイアログ表示
  - 削除後、動画一覧から消えるか確認
- [ ] 組織管理ページにアクセス試行
  - アクセス拒否されるか（403または404）
- [ ] ログアウト

### Phase 3: デバッグコードの削除
**所要時間**: 1時間

1. [ ] `console.log`, `console.warn`を削除または`console.error`に変更
   - `hooks/useUpload.ts`
   - `app/shop/stats/page.tsx`
   - `app/admin/organizations/page.tsx`
   - `hooks/useAuth.ts`
   - `hooks/useOrganizationStats.ts`
   - `app/login/page.tsx`
2. [ ] 機密情報（トークン、署名付きURL全体）が出力されていないか確認
3. [ ] ローカルビルドテスト（`npm run build`）
4. [ ] Git commit & push
5. [ ] Amplify自動デプロイ完了確認

### Phase 4: エラーハンドリングの確認
**所要時間**: 1-2時間

1. [ ] **ネットワークエラーのシミュレーション**
   - DevToolsでネットワークをオフラインに設定
   - 各ページでAPIリクエスト時の挙動を確認
   - エラーメッセージが適切に表示されるか
2. [ ] **認証エラーのシミュレーション**
   - 無効なトークンでAPIリクエスト
   - ログアウト後のページ遷移
   - セッション期限切れ時の挙動
3. [ ] **無効なデータ入力のテスト**
   - 空のタイトルで動画アップロード試行
   - 不正なファイル形式（非MP4）でアップロード試行
   - 大きすぎるファイル（>50MB）でアップロード試行
4. [ ] **タイムアウトのテスト**
   - 大きなファイルのアップロード（ネットワーク速度制限）
   - タイムアウト時のエラーハンドリング確認

---

## ⏰ タイムライン（2日間）

### Day 1（今日）- 機能検証とテスト
- [ ] **0-2時間**: Phase 1（アップロード機能検証）
- [ ] **2-5時間**: Phase 2（全ロール動作確認）
- [ ] **5-6時間**: Phase 3（デバッグコード削除）
- [ ] **6-7時間**: Phase 4（エラーハンドリング確認）
- [ ] **7-8時間**: 緊急修正対応バッファ

### Day 2（明日）- 最終確認とリリース準備
- [ ] **0-1時間**: パスワードリセット機能テスト
- [ ] **1-2時間**: セキュリティ簡易チェック
- [ ] **2-4時間**: 最終動作確認（スモークテスト）
- [ ] **4-5時間**: ドキュメント整備
- [ ] **5-6時間**: 本番リリース準備（バックアップ、ロールバック計画）
- [ ] **6時間以降**: リリース判定会議

---

## 🎯 リリース判定基準

### ✅ Go判定（リリース可能）
1. ✅ 動画アップロード機能が正常動作（S3、DynamoDB、表示）
2. ✅ 全ユーザーロール（system-admin, org-admin, shop-admin）でログイン可能
3. ✅ 主要機能（動画一覧、統計、管理）が正常動作
4. ✅ 重大なセキュリティ問題なし
5. ✅ デバッグコード削除完了
6. ✅ エラーハンドリングが適切

### 🚫 No-Go判定（リリース延期）
1. 動画アップロードが動作しない（S3エラー、認証エラー等）
2. 認証エラーでログインできない
3. データ破損や不整合が発生
4. 重大なセキュリティ脆弱性発見（例: 他ユーザーのデータ閲覧可能）
5. パフォーマンスが著しく悪い（ページ読み込み >10秒）
6. ユーザー体験を著しく損なうバグ

---

## 📋 チェックリスト

### 機能確認
- [ ] 動画アップロード（S3直接アップロード）
- [ ] 動画一覧表示（ロール別フィルタリング）
- [ ] 動画削除
- [ ] 販売店作成（Cognito + DynamoDB）
- [ ] 組織作成（DynamoDB）
- [ ] 統計表示（システム・組織・販売店）
- [ ] パスワードリセット（メール送信）
- [ ] ログイン/ログアウト
- [ ] 販売店編集機能

### 非機能確認
- [ ] レスポンス時間（主要ページ <3秒）
- [ ] エラーハンドリング（適切なメッセージ表示）
- [ ] ローディング表示（スピナー、プログレスバー）
- [ ] モバイル対応（レスポンシブデザイン）
- [ ] ブラウザ互換性（Chrome, Safari, Firefox）

### セキュリティ
- [ ] HTTPS通信（本番環境）
- [ ] 認証・認可（Cognito + API Gateway）
- [ ] CORS設定（現在`*`、本番では制限推奨）
- [ ] 機密情報の暗号化（環境変数、DynamoDB）
- [ ] XSS対策（React自動エスケープ）
- [ ] CSRF対策（Amplify Auth）
- [ ] S3バケットのパブリックアクセスブロック

### 運用
- [ ] CloudWatch Logs確認（エラーログ、警告ログ）
- [ ] DynamoDBデータ整合性（組織、販売店、動画の関連）
- [ ] S3バケット容量確認（現在の使用量）
- [ ] Cognito User Pool設定確認（パスワードポリシー）
- [ ] Lambda関数のタイムアウト設定確認（現在29秒）
- [ ] API Gatewayのタイムアウト設定確認（現在29秒）

---

## 📞 緊急連絡先とエスカレーションプラン

### エスカレーション基準
- **Level 1（軽微）**: 機能の一部が動作しない（代替手段あり）
  - 対応時間: 4時間以内
  - 例: 統計表示の一部が0になる
- **Level 2（中度）**: 主要機能が動作しない（ワークアラウンドあり）
  - 対応時間: 2時間以内
  - 例: 動画削除機能が動作しない
- **Level 3（重大）**: システムのコア機能が動作しない
  - 対応時間: 即座
  - 例: 動画アップロードが完全に失敗、全ユーザーがログインできない

### ロールバック計画
1. **Amplifyフロントエンド**: 前回のデプロイに戻す（Amplify Console）
2. **Lambda関数**: 前回のバージョンに戻す（AWS Console）
3. **DynamoDBデータ**: ポイントインタイムリカバリ（最大35日前まで）
4. **S3データ**: バージョニングで以前のバージョンに戻す

---

## 🔍 既知の問題と制限事項

### 既知の問題
1. **組織管理者の動画アップロード**: 直接アップロード不可（設計通り）
2. **パスワード表示**: ログイン情報モーダルにパスワード非表示（セキュリティ上の設計）

### 制限事項
1. **動画サイズ**: 最大50MB
2. **動画形式**: MP4のみ
3. **同時アップロード**: 1ファイルずつ
4. **API レート制限**: 未設定（リリース後に設定推奨）

---

## 📚 参考ドキュメント

### システム関連
- [TEST_ACCOUNTS.md](./TEST_ACCOUNTS.md) - テストアカウント一覧
- [PROGRESS.md](./PROGRESS.md) - 開発進捗履歴
- [DEPLOY_FIX_NOTES.md](./DEPLOY_FIX_NOTES.md) - デプロイ問題と修正履歴

### AWS関連
- Amplify Console: https://console.aws.amazon.com/amplify/home?region=ap-northeast-1
- API Gateway: https://console.aws.amazon.com/apigateway/home?region=ap-northeast-1
- Lambda: https://console.aws.amazon.com/lambda/home?region=ap-northeast-1
- DynamoDB: https://console.aws.amazon.com/dynamodb/home?region=ap-northeast-1
- S3: https://console.aws.amazon.com/s3/home?region=ap-northeast-1
- CloudWatch: https://console.aws.amazon.com/cloudwatch/home?region=ap-northeast-1
- Cognito: https://console.aws.amazon.com/cognito/home?region=ap-northeast-1

---

## 📝 メモ欄

### テスト結果記録
```
日時: ___________
テスト担当者: ___________

Phase 1 結果:
- アップロード成功: [ ] Yes [ ] No
- エラー内容: ___________

Phase 2 結果:
- System Admin: [ ] OK [ ] NG
- Org Admin: [ ] OK [ ] NG
- Shop Admin: [ ] OK [ ] NG

Phase 3 結果:
- デバッグコード削除: [ ] 完了 [ ] 未完了

Phase 4 結果:
- エラーハンドリング: [ ] OK [ ] NG

リリース判定: [ ] Go [ ] No-Go
理由: ___________
```

