# 承認ベース組織管理ワークフロー - 実装完了

## 📋 概要

非エンジニアでも管理しやすい、承認ベースの組織登録システムを実装しました。

## 🎯 実装したワークフロー

### 1️⃣ パートナー企業登録フロー

```
システム管理者 → 企業担当者 → フォーム入力 → 承認 → アカウント作成
```

1. システム管理者が「承認申請作成」をクリック
2. 企業担当者のメールアドレスを入力
3. システムが自動でフォームURLを生成・メール送信
4. 企業担当者がフォームに情報入力・送信
5. システム管理者の承認ダッシュボードに通知
6. システム管理者が内容確認・承認
7. 自動でCognitoユーザーアカウント作成
8. ID/PASSを企業担当者にメール送信
9. 組織一覧に自動追加

### 2️⃣ 販売店登録フロー

```
パートナー企業管理者 → 販売店担当者 → フォーム入力 → 承認 → アカウント作成
```

1. パートナー企業管理者が「承認申請作成」をクリック
2. 販売店担当者のメールアドレスを入力
3. システムが自動でフォームURLを生成・メール送信
4. 販売店担当者がフォームに情報入力・送信
5. パートナー企業管理者の承認ダッシュボードに通知
6. パートナー企業管理者が内容確認・承認
7. 自動でCognitoユーザーアカウント作成
8. ID/PASSを販売店担当者にメール送信
9. パートナー企業配下に販売店が自動追加

## 🏗 実装したコンポーネント

### バックエンド（AWS CDK）

#### 1. DynamoDB テーブル
- **ApprovalRequestTable**
  - `requestId` (PK): 申請ID
  - `requestType`: 'agency' | 'store'
  - `status`: 'pending' | 'submitted' | 'approved' | 'rejected'
  - `recipientEmail`: フォーム送信先メール
  - `approverEmail`: 承認者メール
  - `submissionData`: フォーム入力データ
  - `expiresAt`: 有効期限（TTL、30日後自動削除）
  
- **GSI (Global Secondary Index)**
  - `approverEmail-status-index`: 承認者の承認待ち一覧取得
  - `status-createdAt-index`: ステータス別の申請一覧取得

#### 2. Lambda 関数

| 関数名 | エンドポイント | 認証 | 説明 |
|--------|---------------|------|------|
| `createApprovalRequest` | `POST /approvals` | 必須 | 承認申請作成・フォームURL送信 |
| `getPendingApprovals` | `GET /approvals` | 必須 | 承認待ち一覧取得 |
| `getApprovalRequest` | `GET /approvals/{requestId}` | **不要** | 申請詳細取得（公開） |
| `submitApprovalForm` | `POST /approvals/{requestId}/submit` | **不要** | フォーム送信（公開） |
| `approveRequest` | `POST /approvals/{requestId}/approve` | 必須 | 承認・アカウント作成 |
| `rejectRequest` | `POST /approvals/{requestId}/reject` | 必須 | 却下・理由通知 |

#### 3. 統合機能
- **SNS**: メール通知（フォームURL送信、承認通知、ID/PASS送信）
- **Cognito**: 自動ユーザーアカウント作成、グループ割り当て
- **一時パスワード生成**: 複雑度を満たす12文字のランダムパスワード

### フロントエンド（Next.js）

#### 1. 型定義
- **`types/approval.ts`**
  - `ApprovalRequest`: 承認申請データ型
  - `OrganizationFormData`: フォーム入力データ型
  - API Request/Response型

#### 2. カスタムフック
- **`hooks/useApprovals.ts`**
  - `fetchPendingApprovals()`: 承認待ち一覧取得
  - `createApprovalRequest()`: 承認申請作成
  - `approveRequest()`: 承認
  - `rejectRequest()`: 却下

#### 3. コンポーネント

| コンポーネント | パス | 説明 |
|---------------|------|------|
| CreateApprovalModal | `components/CreateApprovalModal.tsx` | 承認申請作成モーダル |
| ApprovalsPage | `app/admin/approvals/page.tsx` | 承認ダッシュボード（管理者用） |
| ApprovalFormPage | `app/public/approval-form/[requestId]/page.tsx` | 公開フォームページ（申請者用） |

#### 4. 機能
- ✅ 承認申請作成（メールでフォームURL送信）
- ✅ 承認待ち一覧表示（統計カード付き）
- ✅ 申請内容の確認
- ✅ 承認・却下アクション
- ✅ フォームURLコピー
- ✅ ステータス表示（pending, submitted, approved, rejected）
- ✅ 公開フォームページ（認証不要）
  - 有効期限表示
  - 組織情報入力フォーム
  - 送信完了・承認済み・却下済み画面

## 🔐 セキュリティ機能

1. **フォームURL有効期限**: 7日間
2. **申請の一意性**: 同じメールアドレスでの重複申請防止
3. **承認権限の分離**: パートナー企業は配下の販売店のみ承認可能
4. **ログ記録**: 全操作の監査ログ（CloudWatch Logs）
5. **自動削除**: 30日後にDynamoDB TTLで自動削除

## 📧 メール通知フロー

### 1. フォーム送信メール（申請作成時）
```
件名: 【動画NFCシステム】組織登録フォーム送信のお知らせ

内容:
- フォームURL
- 入力期限（7日間）
- 必要事項の説明
```

### 2. 承認通知メール（フォーム送信後）
```
件名: 【動画NFCシステム】組織登録申請の承認待ち

内容:
- 申請内容の要約
- 承認URL
```

### 3. アカウント作成完了メール（承認後）
```
件名: 【動画NFCシステム】アカウント作成完了

内容:
- ログインURL
- ユーザーID（メールアドレス）
- 初期パスワード
- 初回ログイン手順
```

### 4. 却下通知メール（却下時）
```
件名: 【動画NFCシステム】登録申請が却下されました

内容:
- 却下理由
```

## 🎨 UI/UX 設計

### 承認ダッシュボード（管理者用）
- 統計カード（承認待ち、承認済み、未送信）
- 承認待ち一覧（申請内容、ステータス表示）
- フォームURLコピー機能
- 承認・却下ボタン
- 却下理由入力モーダル

### 公開フォームページ（申請者用）
- レスポンシブデザイン
- 有効期限表示
- 入力フォーム（組織名、メール、電話、住所）
- 送信完了画面
- エラー表示（期限切れ、申請不存在など）

## 📊 ダッシュボード機能

### 統計カード
- 承認待ち件数
- 承認済み件数
- 未送信件数

### 承認待ち一覧
- 申請タイプ表示（パートナー企業/販売店）
- ステータスバッジ
- 申請内容詳細
- フォームURL（コピー・開く）
- 承認・却下アクション

## 🔄 ステータス遷移

```
pending (未送信)
  ↓ フォーム送信
submitted (承認待ち)
  ↓ 承認
approved (承認済み) ← アカウント作成完了
  または
  ↓ 却下
rejected (却下) ← 却下理由記録
```

## 💡 使用例

### システム管理者がパートナー企業を登録

1. `/admin/approvals` にアクセス
2. 「新規申請作成」をクリック
3. 「パートナー企業」を選択
4. 企業担当者のメールアドレスを入力
5. 「申請を作成」をクリック
6. フォームURLが自動生成され、メール送信される

### 企業担当者がフォームを入力

1. メールに記載されたフォームURLをクリック
2. 組織情報を入力（組織名、メール、電話、住所）
3. 「申請を送信」をクリック
4. 送信完了画面が表示される

### システム管理者が承認

1. `/admin/approvals` の承認待ち一覧に通知表示
2. 申請内容を確認
3. 「承認」ボタンをクリック
4. 自動でCognitoユーザーアカウント作成
5. ID/PASSが企業担当者にメール送信される
6. 組織一覧に自動追加

## 🚀 デプロイ方法

### バックエンド

```bash
# Lambdaビルド
cd lambda
npm install
npm run build

# CDKデプロイ
cd ..
npm run deploy:dev
```

### フロントエンド

```bash
cd video-nfc-admin
npm install
npm run dev
```

## 📝 次のステップ（オプション）

- [ ] メール通知のカスタマイズ（SES使用）
- [ ] 申請履歴の表示
- [ ] 一括承認機能
- [ ] エクスポート機能（CSV/PDF）
- [ ] モバイルアプリ対応

## 📞 サポート

問題が発生した場合は、以下を確認してください：

1. CloudWatch Logs で Lambda エラーログを確認
2. SNS トピックのサブスクリプション確認メールを承認済みか確認
3. Cognito User Pool の設定確認
4. API Gateway の CORS 設定確認

---

最終更新日: 2025-10-09
実装者: AI Assistant






